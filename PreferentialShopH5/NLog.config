<?xml version="1.0" ?>
<configuration>
  <nlog autoReload="true"  throwExceptions="true"  xmTLs="http://www.nlog-project.org/schemas/NLog.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <extensions>
      <add assembly="Tonglu.Logging.NLog"/>
    </extensions>
    <targets>
      <!-- <default-wrapper xsi:type="BufferingWrapper" bufferSize="100" FlushTimeout="10000">
        <wrapper-target xsi:type="AsyncWrapper"/>
      </default-wrapper> -->
      <target xsi:type="Database" name="TLProcessDBLogTarget">
        <!-- SQL command to be executed for each entry -->
        <commandText>
          INSERT INTO LogHandle(RequestKey,LogType ,RequestUrl,UserName,OrderNo,Content,KeyWord,ClientIP,TimeLong,LogTime,ServerDesc,LogLevel,DBCreateTime)
          VALUES(@RequestKey,@LogType,@RequestUrl,@UserName,@OrderNo,@Content,@KeyWord,@ClientIP,@TimeLong,@LogTime,@ServerDesc,@LogLevel,now())
        </commandText>
        <!-- parameters for the command -->
        <parameter name="@RequestKey" layout="${event-properties:item=RequestKey}" />
        <parameter name="@LogType" layout="${event-properties:item=LogType}" />
        <parameter name="@RequestUrl" layout="${event-properties:item=RequestUrl}" />
        <parameter name="@UserName" layout="${event-properties:item=UserName}" />
        <parameter name="@OrderNo" layout="${event-properties:item=OrderNo}" />
        <parameter name="@Content" layout=" ${message}" />
        <parameter name="@KeyWord" layout="${event-properties:item=KeyWord}" />
        <parameter name="@ClientIP" layout="${event-properties:item=ClientIP}" />
        <parameter name="@TimeLong" layout="${event-properties:item=TimeLong}" />
        <parameter name="@LogTime" layout="${event-properties:item=LogTime}" />
        <parameter name="@ServerDesc" layout="${event-properties:item=ServerDesc}" />
        <parameter name="@LogLevel" layout="${event-properties:item=LogLevel}" />

        <!-- connection string -->
        <dbProvider>MySql.Data.MySqlClient</dbProvider>
        <connectionString>server=10.201.80.28;user id=root;password=123456;persistsecurityinfo=True;database=DxlqLog_test</connectionString>
      </target>
      <target name="mail_async" xsi:type="AsyncWrapper">
        <target name="mail_log" xsi:type="Mail" smtpServer="mail.xxx" smtpPort="25"
          smtpUsername="xxx@xxx" smtpPassword="xxx"
          from="xxx@xxx" to="xxx@xxx" html="true"
          subject="异常监控，来源：${NLogSource}" layout="&lt;strong&gt;来源：&lt;/strong&gt;${NLogSource} &lt;br/&gt; &lt;strong&gt;时间：&lt;/strong&gt;${longdate} &lt;br/&gt; &lt;strong&gt;路径：&lt;/strong&gt;${stacktrace} &lt;br /&gt; &lt;strong&gt;消息：&lt;/strong&gt;${message} &lt;br /&gt; &lt;br /&gt;"/>
      </target>

      <target name="file_log" xsi:type="File" fileName="${LogPath}/${logger}/${logger}_${shortdate}.html"
             layout="&lt;strong&gt;时间：&lt;/strong&gt;${longdate} &lt;br/&gt; 
              &lt;strong&gt;路径：&lt;/strong&gt;${stacktrace} &lt;br /&gt; 
              &lt;strong&gt;消息：&lt;/strong&gt;${message} &lt;br /&gt; &lt;br /&gt;
              "/>

      <target name="exception_log" xsi:type="File" fileName="${LogPath}/${logger}/${logger}_${shortdate}.html"
              layout="&lt;strong&gt;时间：&lt;/strong&gt;${longdate} &lt;br/&gt; 
              &lt;strong&gt;调用消息：&lt;/strong&gt;${message} &lt;br /&gt; 
              &lt;strong&gt;路径：&lt;/strong&gt;${stacktrace} &lt;br /&gt; 
              &lt;strong&gt;异常类型：&lt;/strong&gt;${exception:format=type} &lt;br /&gt; 
              &lt;strong&gt;异常消息：&lt;/strong&gt;${exception:format=message} &lt;br /&gt; 
              &lt;strong&gt;调用方法：&lt;/strong&gt;${exception:format=method} &lt;br /&gt; 
              &lt;strong&gt;异常堆栈：&lt;/strong&gt;${exception:format=stacktrace} &lt;br /&gt; 
              &lt;strong&gt;异常数据：&lt;/strong&gt;${exception:format=data} &lt;br /&gt; &lt;br /&gt;
      "/>

      <target name="webmessage_log" xsi:type="File" fileName="${LogPath}/${logger}/${logger}_${shortdate}.html"
        layout="&lt;strong&gt;时间：&lt;/strong&gt;${longdate} &lt;br/&gt; 
              ${WebMessage}
              "/>

      <target xsi:type="Network"
        name="udp_log"
        onOverflow="Split"
        layout="EXCEPTION_SOURCE[:]${NLogSource}[seperate]CREATE_TIME[:]${longdate}[seperate]EXCEPTION_STACK[:]${stacktrace}[seperate]EXCEPTION_MESSAGE[:]${message}"
        maxMessageSize="30720"
        encoding="utf-8"
        address="${NLogUdpAddress}" />


    </targets>
    <rules>

      <logger name="TLProcessDBLog" minlevel="Trace" writeTo="TLProcessDBLogTarget"  />
      <logger name="*" minlevel="Trace" writeTo="file_log" />

      <logger name="tracelog" minlevel="Trace" writeTo="file_log" />
      <logger name="sqllog" minlevel="Trace" writeTo="file_log" />
      <logger name="servicelog" minlevel="Trace" writeTo="file_log" />
      <logger name="exceptionlog" minlevel="Trace" writeTo="exception_log,udp_log" />
      <logger name="exceptionlog_debug" minlevel="Trace" writeTo="exception_log" />

      <logger name="requestlog" minlevel="Trace" writeTo="webmessage_log" />
      <logger name="responselog" minlevel="Trace" writeTo="webmessage_log" />
    </rules>
  </nlog>
</configuration>
